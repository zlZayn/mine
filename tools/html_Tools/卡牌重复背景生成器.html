<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¡”ç½—ç‰Œé‡å¤èƒŒæ™¯ç”Ÿæˆå™¨ - é«˜æ¸…ç‰ˆ</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: #110f0f;
            overflow: hidden;
            font-family: 'Segoe UI', sans-serif;
        }

        /* æ§åˆ¶é¢æ¿ */
        #controls {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 100;
            background: rgba(20, 20, 20, 0.95);
            backdrop-filter: blur(15px);
            padding: 50px;
            border-radius: 20px;
            box-shadow: 0 15px 50px rgba(0,0,0,0.9);
            text-align: center;
            border: 1px solid rgba(224, 192, 128, 0.3);
            transition: opacity 0.8s ease, visibility 0.8s;
        }

        input[type="file"] { display: none; }

        .custom-file-upload {
            display: inline-block;
            padding: 18px 36px;
            cursor: pointer;
            background: linear-gradient(135deg, #d4af37, #bfa030);
            color: #1a1a1a;
            font-weight: bold;
            font-size: 1.2em;
            border-radius: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 5px 20px rgba(212, 175, 55, 0.3);
        }

        .custom-file-upload:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(212, 175, 55, 0.5);
        }

        #status {
            margin-top: 25px;
            color: #e0c080;
            font-size: 14px;
            letter-spacing: 1px;
        }

        #patternCanvas {
            display: block;
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 2s ease;
        }

        /* å¯¼å‡ºæŒ‰é’®æ ·å¼ */
        #downloadBtn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 99;
            padding: 12px 24px;
            background: rgba(20, 20, 20, 0.8);
            border: 1px solid #d4af37;
            color: #d4af37;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            letter-spacing: 1px;
            backdrop-filter: blur(5px);
            opacity: 0;
            visibility: hidden;
            transition: all 0.5s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }

        #downloadBtn:hover {
            background: #d4af37;
            color: #1a1a1a;
            box-shadow: 0 5px 25px rgba(212, 175, 55, 0.4);
        }
    </style>
</head>
<body>

    <div id="controls">
        <label for="fileInput" class="custom-file-upload">
            âœ¨ è½½å…¥å¡ç‰Œèµ„æº âœ¨
        </label>
        <input type="file" id="fileInput" multiple accept="image/*">
        <div id="status">å¯¼å…¥åå°†è‡ªåŠ¨æ„å»ºå…¨å±çº¹æ ·</div>
    </div>

    <button id="downloadBtn" onclick="exportHighRes()">ğŸ’¾ å¯¼å‡ºé«˜æ¸…å¤§å›¾ (4x)</button>

    <canvas id="patternCanvas"></canvas>

    <script>
        const fileInput = document.getElementById('fileInput');
        const statusDiv = document.getElementById('status');
        const canvas = document.getElementById('patternCanvas');
        const controlsDiv = document.getElementById('controls');
        const downloadBtn = document.getElementById('downloadBtn');

        let loadedImages = [];

        // çª—å£è°ƒæ•´æ—¶é‡ç»˜é¢„è§ˆï¼ˆæ™®é€šåˆ†è¾¨ç‡ï¼‰
        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            if (loadedImages.length > 0) {
                renderPatternToCanvas(canvas, 1);
            }
        });

        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        fileInput.addEventListener('change', async (e) => {
            const files = Array.from(e.target.files);
            if (files.length === 0) return;

            statusDiv.textContent = "æ­£åœ¨ç¼–ç»‡çº¹æ ·...";
            
            try {
                const promises = files.map(file => {
                    return new Promise((resolve) => {
                        const img = new Image();
                        img.onload = () => resolve(img);
                        img.src = URL.createObjectURL(file);
                    });
                });

                loadedImages = await Promise.all(promises);
                
                // éšè—UI
                controlsDiv.style.opacity = '0';
                setTimeout(() => controlsDiv.style.visibility = 'hidden', 800);

                // ç»˜å›¾å¹¶æ˜¾ç¤º
                renderPatternToCanvas(canvas, 1);
                canvas.style.opacity = '1';
                
                // æ˜¾ç¤ºä¸‹è½½æŒ‰é’®
                downloadBtn.style.visibility = 'visible';
                downloadBtn.style.opacity = '1';

            } catch (err) {
                console.error(err);
                statusDiv.textContent = "è¯»å–å¤±è´¥ï¼Œè¯·é‡è¯•";
            }
        });

        /**
         * æ ¸å¿ƒç»˜å›¾å‡½æ•°
         * @param {HTMLCanvasElement} targetCanvas - ç›®æ ‡ç”»å¸ƒ
         * @param {number} scaleFactor - ç¼©æ”¾å€ç‡ (1ä¸ºå±å¹•é¢„è§ˆ, 4ä¸ºé«˜æ¸…å¯¼å‡º)
         */
        function renderPatternToCanvas(targetCanvas, scaleFactor = 1) {
            if (loadedImages.length === 0) return;

            const ctx = targetCanvas.getContext('2d');
            const w = targetCanvas.width;
            const h = targetCanvas.height;

            // ç»˜åˆ¶åº•è‰²
            ctx.fillStyle = "#12100e";
            ctx.fillRect(0, 0, w, h);
            
            // è®¾å®šå¡ç‰‡å›ºå®šå®½åº¦ï¼šä»¥ç”»å¸ƒæœ€å°è¾¹çš„ 15% ä¸ºåŸºå‡†
            // æ³¨æ„ï¼šå› ä¸º w å’Œ h å·²ç»åŒ…å«äº† scaleFactorï¼Œæ‰€ä»¥è¿™é‡Œä¸éœ€è¦é¢å¤–ä¹˜ scaleFactor
            const fixedWidth = Math.min(w, h) * 0.15;
            
            // å¯†åº¦è®¡ç®—
            // ä¿æŒå¯†åº¦ä¸€è‡´æ€§ï¼Œæ— è®ºç”»å¸ƒå¤šå¤§ï¼Œè¦†ç›–ç‡åº”è¯¥ç›¸ä¼¼
            const density = 50; 
            const drawCount = Math.floor((w * h) / (fixedWidth * fixedWidth) * density);
            
            // é˜´å½±å‚æ•°éœ€è¦éšæ¯”ä¾‹ç¼©æ”¾
            ctx.shadowColor = "rgba(0, 0, 0, 0.7)";
            ctx.shadowBlur = 20 * scaleFactor;
            ctx.shadowOffsetX = 8 * scaleFactor;
            ctx.shadowOffsetY = 8 * scaleFactor;

            // ä¸ºäº†ä¿è¯æ¯æ¬¡ç”Ÿæˆï¼ˆé¢„è§ˆ vs å¯¼å‡ºï¼‰çš„éšæœºä½ç½®å°½é‡â€œåƒâ€æ˜¯åŒä¸€å¥—é€»è¾‘
            // æˆ‘ä»¬å¯ä»¥ç”¨ seeded randomï¼Œä½†ä¸ºäº†ç®€åŒ–ï¼Œè¿™é‡Œé‡æ–°éšæœºç”Ÿæˆå³å¯
            // å¦‚æœå¸Œæœ›å¯¼å‡ºå›¾å’Œå½“å‰é¢„è§ˆå›¾çš„å¸ƒå±€ *å®Œå…¨* ä¸€æ¨¡ä¸€æ ·ï¼Œéœ€è¦ä¿å­˜éšæœºç§å­ï¼Œ
            // ä½†å¯¹äºè¿™ç§ç”Ÿæˆå™¨ï¼Œé‡æ–°ç”Ÿæˆä¸€å¼ åŒæ ·é£æ ¼çš„é«˜æ¸…å›¾é€šå¸¸ä¹Ÿå¯ä»¥æ¥å—ã€‚
            
            for (let i = 0; i < drawCount; i++) {
                const img = loadedImages[Math.floor(Math.random() * loadedImages.length)];
                
                const x = Math.random() * w;
                const y = Math.random() * h;

                // æ—‹è½¬é€»è¾‘
                const baseRotate = Math.random() < 0.5 ? 0 : Math.PI;
                const tilt = (Math.random() - 0.5) * 2 * (10 * Math.PI / 180);
                
                const aspect = img.height / img.width;
                const cardH = fixedWidth * aspect;

                ctx.save();
                ctx.translate(x, y);
                ctx.rotate(baseRotate + tilt);
                
                // ç»˜åˆ¶
                ctx.drawImage(img, -fixedWidth / 2, -cardH / 2, fixedWidth, cardH);
                ctx.restore();
            }

            // æš—è§’æ»¤é•œ
            drawVignette(ctx, w, h);
        }

        function drawVignette(ctx, w, h) {
            ctx.save();
            ctx.shadowColor = "transparent";
            const grad = ctx.createRadialGradient(
                w/2, h/2, w/4,
                w/2, h/2, Math.max(w, h)
            );
            grad.addColorStop(0, "transparent");
            grad.addColorStop(1, "rgba(0,0,0,0.85)");
            ctx.fillStyle = grad;
            ctx.globalCompositeOperation = 'multiply';
            ctx.fillRect(0, 0, w, h);
            ctx.restore();
        }

        // é«˜æ¸…å¯¼å‡ºåŠŸèƒ½
        function exportHighRes() {
            if (loadedImages.length === 0) return;

            const originalText = downloadBtn.textContent;
            downloadBtn.textContent = "ç”Ÿæˆä¸­...";
            downloadBtn.style.background = "#fff";
            downloadBtn.style.color = "#000";

            // ä½¿ç”¨ setTimeout è®© UI æœ‰æœºä¼šåˆ·æ–°æ–‡å­—
            setTimeout(() => {
                // 1. åˆ›å»ºç¦»å± Canvas
                const offCanvas = document.createElement('canvas');
                const scale = 4; // æ”¾å¤§å€æ•°ï¼Œå¯è‡ªè¡Œè°ƒæ•´ (4 = 4K/8Kçº§åˆ«)

                // 2. è®¾ç½®ä¸ºå±å¹•åˆ†è¾¨ç‡çš„ N å€
                offCanvas.width = window.innerWidth * scale;
                offCanvas.height = window.innerHeight * scale;

                // 3. åœ¨å¤§ç”»å¸ƒä¸Šç»˜å›¾
                renderPatternToCanvas(offCanvas, scale);

                // 4. è½¬æ¢ä¸ºå›¾ç‰‡å¹¶ä¸‹è½½
                try {
                    const link = document.createElement('a');
                    // ç”Ÿæˆæ—¶é—´æˆ³æ–‡ä»¶å
                    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                    link.download = `Tarot_Pattern_${timestamp}_HighRes.png`;
                    link.href = offCanvas.toDataURL('image/png', 1.0); // 1.0 = æœ€é«˜è´¨é‡
                    link.click();
                } catch(e) {
                    alert("å›¾ç‰‡ç”Ÿæˆå¤±è´¥ï¼Œå¯èƒ½æ˜¯å›¾ç‰‡è¿‡å¤§ã€‚");
                } finally {
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    downloadBtn.textContent = originalText;
                    downloadBtn.style.background = "rgba(20, 20, 20, 0.8)";
                    downloadBtn.style.color = "#d4af37";
                    offCanvas.remove(); // æ¸…ç†å†…å­˜
                }
            }, 100);
        }
    </script>
</body>
</html>